<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de">

    <head>

        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <!-- <link href="project.css" rel="stylesheet" type="text/css" /> -->
        <style type="text/css">

            * {

                margin:             0;
                padding:            0;
            }

            body,
            html {
                height: 100%;
            }

            .viewport {
                position: relative;
                overflow: hidden;
                width: 100%;
                height: 100%;
                background-color: #000;
            }

            .viewport * {
                position: absolute;
                left: 50%;
                top: 50%;
                transform-style: preserve-3d;
            }

            #square1 {
                width: 500px;
                height: 500px;
                margin-left: -250px;
                margin-top: -250px;
                background: red;
            }

            #square2 {
                width: 50px;
                height: 50px;
                margin-left: -25px;
                margin-top: -25px;
                background: green;
                transform: translate3d(0px, 0px, 50px);
            }

        </style>

        <script type="text/javascript" src="../../../node_modules/gl-matrix/gl-matrix-min.js"></script>

    </head>

    <body>
        <div class="viewport" style="perspective: 423.668px;">
            <!--
                camera: rotation only

                transform: translate3d(0px, 0px, 423.67px) rotateX(-90deg) rotateY(745deg) rotateZ(0deg) skewX(0deg) skewY(0deg);
            -->
            <div
                class="camera viewport__entity"
                style="transform: translate3d(0px, 0px, -423.67px) rotateX(0deg) rotateY(0deg) rotateZ(0deg);"
            >
                <!--
                    translation, rotation x - z

                    transform: translate3d(0px, 0px, 423.67px) rotateX(-90deg) rotateY(745deg) rotateZ(0deg) skewX(0deg) skewY(0deg);
                -->
                <div class="world viewport__entity"
                    style="transform: translate3d(0px, 0px, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg);"
                >
                    <div id="square1"></div>
                    <div id="square2"></div>
                </div>
            </div>
        </div>

<script type="text/javascript">
const { vec3: v, mat4, glMatrix: gl } = glMatrix;

window.camera = {
    el: document.querySelector(".camera"),
    rotation: v.create(),
    position: v.create(),
    cameraMatrix: mat4.create(),
    setM(m) {
        this.el.style.transform = `matrix3d(${m.join(",")})`;
    },
    rotate(rotation) {
        v.add(this.rotation, this.rotation, rotation);
        this.update();
    },
    translate(position) {
        v.add(this.position, this.position, position);
        this.update();
    },
    update() {
        const { cameraMatrix: matrix } = this;
        mat4.identity(matrix);
        mat4.translate(matrix, matrix, this.position);
        mat4.rotateZ(matrix, matrix, gl.toRadian(this.rotation[2]));
        mat4.rotateX(matrix, matrix, gl.toRadian(this.rotation[0]));
        world.update();
    },
    forward(distance = 1) {
        const { cameraMatrix } = this;
        const forwardVector = v.set(v.create(), cameraMatrix[2], cameraMatrix[6], cameraMatrix[10]);
        // @check why is this required, forward is pointing in wrong z-direction. construction error?
        forwardVector[2] = -forwardVector[2];
        v.scale(forwardVector, forwardVector, distance);
        this.translate(forwardVector);
    },
    render() {
        this.setM(matrix);
    }
}

window.world = {
    el: document.querySelector(".world"),
    rotation: v.create(),
    position: v.create(),
    worldMatrix: mat4.create(),
    setM(m) {
        this.el.style.transform = `matrix3d(${m.join(",")})`;
    },
    rotate(rotation) {
        v.add(this.rotation, this.rotation, rotation);
        this.update();
    },
    translate(position) {
        v.add(this.position, this.position, position);
        this.update();
    },
    update() {
        const viewmatrix = mat4.invert(mat4.create(), window.camera.cameraMatrix);
        const modelViewMatrix = mat4.multiply(mat4.create(), this.worldMatrix, viewmatrix);
        this.setM(modelViewMatrix);
    }
}

camera.rotate(v.fromValues(-40, 0, 0));
camera.translate(v.fromValues(250, 250, 0));
// camera.forward(200);
// camera.rotate(v.fromValues(10, 0, 0));
</script>

    </body>
</html>
